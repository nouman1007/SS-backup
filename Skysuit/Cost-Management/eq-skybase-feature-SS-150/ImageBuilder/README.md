# Image Builder Pipelines.
## Description
EC2 Image Builder, a service that makes it easier and faster to build and maintain secure OS images for Windows Server and Amazon Linux 2, using automated build pipelines. AWS provides security hardening policies that you can use as a starting point to meet the “Security Technical Implementation Guide (STIG)” standard needed to operate in regulated industries.

The pipelines that can configure for EC2 Image Builder include the image recipe, infrastructure configuration, distribution, and test settings, to produce the resulting images. This includes the ability to automatically provision images as new software updates, including security patches, become available. As new images are created by the pipelines, you can additionally configure automated tests to be run to validate the image, before then distributing it to AWS regions that you specify.
## Components of Solution.
Designed solution deploys two separate pipelines one for creating Windows AMIs and one for creating Centos AMIs.
### Cloudfomration templates:

Following templates are needed to deploy when working with Image Builder.

1. network_stack.yaml 

    Creates VPC, Subnets, Route Tables, IGW, NAT for instances for image builder pipeline.

2. lambda_to_create_piplines.yaml 

    Cloud formation template creates two lambda functions: 
    
    a. pick-latest-ami-and-create-instance.py

    Functionality:

    Lambda picks the latest centos AMI, creates instance with said AMI, picks user data for instance from S3 i.e. script.sh. User data invokes second lambda function by passing payload.

    b. terminate_instance_and_create_pipeline_stack.py

    Functionality:

    Terminates the instance created by lambda function pick-latest-ami-and-create-instance.py, and deploy nested_template.yaml

    
3. nested_template.yaml

    Contains two child stacks: 
    
    a. windows_image_builder.yaml 

    Creates window image builder pipeline using latest Windows AMI as parent AMI.

    b. linux_image_builder.yaml

    Creates centos image builder pipeline using AMI generated by lambda at step 2a

4. lambda-to-pick-latest-AMIs-from-pipeline-and-store-in-ssm.yaml

    Template creates lambda function: 

    a. pick-latest-amis-from-pipeline-and-store-in-ssm.py

    Functionality: Lambda picks latest AMI from pipeline and store in SSM Parameters. 
---
## Deployment Steps
Before deployment make sure you have fulfilled the following pre-requisites:
### Pre-requisites:
1. Choose AWS Account (member account e.g. 111111111111) for creating image builder pipelines.

2. Go to AWS master account (222222222222) for creation of Assume role with trust relationship with member account (111111111111). Go to IAM console, select Roles, click on Create Role, Click on Another AWS Account. Give account ID ie 111111111111 Create Assume role and copy the ARN.

- **Note**  Now Onwards, perform steps in member account (111111111111)

3. Create S3 bucket in specific region e.g. us-east-1. 
    
    E.g. Bucket Name: "skysuite-ami-builder"

4. Create Key Pair in same region from AWS Console, as you will be needing it later for parameters.

5. Modify line number 15(export AMI) and 18(aws lambda invoke) in **script.sh** and replace the region with your chosen region and save file. Also give name to function in line 18(aws lambda invoke) and remember it as will need when you proceed further. 

        --region us-east-1

        --function-name ss-create-stack

6. Replace the following variables in pick-latest-ami-and-create-instance.py file.

        REGION = us-east-1 
        BUCKET = <your bucket name created in step 3>

7. Upload following files to bucket created.

    a. windows_image_builder.yaml

    b. linux_image_builder.yaml

    c. pick-latest-ami-and-create-instance.zip
    
    e. pick-latest-amis-from-pipeline-and-store-in-ssm.zip

    f. script.sh

    g. ami-sharing-across-accounts.zip 

6. Copy the URL of **windows_image_builder.yaml** & **linux_image_builder.yaml** from s3 and replace it in line 84 & 99 respectively of **nested_template.yaml**.

7. Upload nested_template.yaml in s3 bucket and copy the URL.

8. Replace the copied URL in step 7 in **terminate_instance_and_create_pipeline_stack.py** at line 136. Also replace the Region variable with your selected region at Line 11.

9. Upload **terminate_instance_and_create_pipeline_stack.zip** to bucket.

10. Go to link https://aws.amazon.com/marketplace/pp?sku=aw0evgkw8e5c1q413zgy5pjce and subscribe it to be able to use Market Place CentOS AMI.

**Below steps should be perform in AWS Account (Member  e.g. 111111111111)**
## Step 1
- Go to AWS Cloudformation console and deploy the **netwrok_stack.yaml** . Description and Parameters mentioned below.

- Provide Bucket name (Pre-requisites step 3) , key pair name (Pre-requisites step 4) and Assume role ARN (Pre-requisites step 2).
### Parameters in network_stack.yaml
Parameters         |Description                                         |Allowed Values|
-------------------|----------------------------------------------------|-----------------| 
pVPCName           |A name that is prefixed to resource names           |Image-Builder
pVpcCIDR           |CIDR notation for the VPC                           |10.0.0.0/24
pPublicSubnetCIDR  |IP range for Public Subnet                          |10.0.0.0/25
pPrivateSubnetCIDR |IP range for Private Subnet                         |10.0.0.128/25
pKeyName           |Keypair name for SSH                                |image-builder 
pAssumeRoleARN     |Assume role ARN                                     |arn:aws:iam::222222222222:role/assumerole_nsardar
pBucketName        |Bucket name                                         |skysuite-ami-builder
---
## Step 2
- Go to AWS Cloudfomration console and deploy **lambda-to-create-pipelines.yaml**. Description and Parameters used mentioned below.

- Provide name of fuction set in Pre-requisite's  step 5 in parameter "pSecondFunctionName".

- Choose the ARN of components for pipeline from EC2 Image Builder Components Console. Eg: For "pWindowRebootComponents" select Windows Reboot component "arn:aws:imagebuilder:us-east-1:aws:component" 
### Parameters for lambda_to_create_piplines.yaml

Parameters              |Description                                     |Allowed Values|
--------------------------|---------------------------------|--------------|
pBucketName               |Give bucket name you created earlier|skysuite-ami-builder
pCentosComponents         |Arn of Centos Component according to region|arn:aws:imagebuilder:us-east-1:aws:component/stig-build-linux-medium/2.6.0/1
pCentosDistributionConfiguration|Give distribution anem for centios image builder pipeline|ss-centos-distribution
pCentosImagePipeline|Give name for centos pipeline|ss-centos-image-pipeline
pCentosImageRecipe|Give name for image recipe of centos pipeline|ss-Centos-recipe
pCentosInfrastructureConfiguration|Give name for centos infrastructure configuration |ss-centos-infra-config
pStackName                |Give unique name of stack to create pipelines.  |image-builders-stack
pFirstFunctionName          |Give name for funtion which will pick the latest AMI for centos and create instance with that to run script.|create-instance
pSecondFunctionName     |Use function name mentioned in shell script |create-stack
pRoleName |Role that will attach to EC2 instance created by lambda to perform installations and invoke second lambda with payload.| instance-role
pInstanceProfileName|Instance profile name for pipeline|ss-instance-profile
pNetworkStackName|Give name of Network stack created earlier|networkstack
pWindowDistributionConfigurationName|Give name foe Window Distribution Configuration|ss-window-distribution
pWindowImagePipelineName|Give name for Window IMage Builder Pipeline|ss-window-image-pipeline
pWindowImageRecipeName|Give name for Window pipeline's Recipe.|ss-window-recipe
pWindowInfrastructureConfigurationName|Give name for Window Infrastructure Configuration.|ss-window-infra-config
pWindowParentImage|Parent Image for the Image recipe|/aws/service/ami-windows-latest/Windows_Server-2019-English-Full-Base
pWindowRebootComponents|Provide reboot Components arn of the Image recipe according to region|arn:aws:imagebuilder:us-east-1:aws:component/reboot-windows/1.0.1/1
pWindowStigComponents|Provide stig Components arn of the Image recipe according to region.|arn:aws:imagebuilder:us-east-1:aws:component/stig-build-windows-medium/1.0.0/1|
---
- Run the Lambda named "create-instance" from above parameter's list manually and wait for a while. The result will be Image builder pipelines. 

- This Lambda will pick latest Centos AMI and create instance by using that AMI and install the **script.sh** as user data(provided in package). User data script will install AWS CLI and SSM agent on instance and create image of instance. At last user data will invoke the lambda pSecondFunctionName ie **create-stack**. This lambda function will terminate the temporary instance and create cloudformation stack resources comprises of pipelines. 

- Go to image builder console and run the Image builder Pipelines and wait for a while. It will create customized AMIs. 
## Step 3
- Once Status of Output Images in each pipeline is **Available**, copy the ARN of pipelines.

- Deploy **lambda-to-pick-latest-AMIs-from-pipeline-and-store-in-ssm.yaml** in Cloudformation by providing ARN of pipelines copied from above step as parameters. Description and Parameters used mentioned below.

- Provide Bucket name (Pre-requisites step 3) in "pBucketName" Parameter.

- This step will create lambda function which will be able to store latest AMIs created by Pipelines in SSM Parameter store.
### Parameters for lambda-to-pick-latest-AMIs-from-pipeline-and-store-in-ssm.yaml

Parameters              |Description            |Allowed Values|
------------------------|------------------------|--------------|
pWindowPipelineARN|Provide Window's Image BUilder Pipeline ARN created before this stack.|arn:aws:imagebuilder:us-east-1:111111111111:image-pipeline/nida-window-image-pipeline
pCentosPipelineARN|Provide Centos Image Builder Pipeilein ARN created before this stack.|arn:aws:imagebuilder:us-east-1:111111111111:image-pipeline/nida-centos-image-pipeline
pWindowsSSMParameterName|Provide window's ssm parameter's name.|/service/ami-windows-latest/windows_server_2019_ami
pCentossSSMParameterName|Provide centos ssm parameter's name.|/service/ami-centos-latest/centos7_ami
pBucketName| Bucket Name | skysuite-ami-builder|
---
- Run the lambda function created in resource section of stack. 

- Go to system's manager and see the created parameters.
## Step 4 
To share the AMI with other accounts, perform following steps:
- Go to lambda console and select the lambda created in resource stack of Step 1. ie **network-stack**.
- Run the lambda manually. It will share the AMI created as as result of pipeline with all accounts which are under the master account (222222222222)
---